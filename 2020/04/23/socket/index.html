<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	
	<!-- title -->
	
	<title>
	
		socket | 
	 
	Been&#39;s Blog
	</title>
	
	<!-- keywords,description -->
	 
		<meta name="description" content="my markdown blog" />
	

	<!-- favicon -->
	
	<link rel="shortcut icon" href="/favicon.ico">
	
  

	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/darcula.min.css">


	
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>

	
<script src="/js/main.js"></script>

	
		
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>

		
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>

	
	
		<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
<meta name="generator" content="Hexo 4.2.0"></head>

<body>
	<header id="header">
    <a id="title" href="/" class="logo">Been's Blog</a>

	<ul id="menu">
		<li class="menu-item">
			<a href="/about" class="menu-item-link">ABOUT</a>
		</li>
		
		<li class="menu-item">
			<a href="https://github.com/wujun234/uid-generator-spring-boot-starter" class="menu-item-link" target="_blank">
				UidGenerator
			</a>
		</li>
		<li class="menu-item">
			<a href="https://github.com/BeenStone01" class="menu-item-link" target="_blank">
				<i class="fa fa-github fa-2x"></i>
			</a>
		</li>
	</ul>
</header>

	
<div id="sidebar">
	<button id="sidebar-toggle" class="toggle" ><i class="fa fa-arrow-right " aria-hidden="true"></i></button>
	
	<div id="site-toc">
		<input id="search-input" class="search-input" type="text" placeholder="search...">
		<div id="tree">
			

			
							<ul>
								<li class="file">
									<a href="/2020/04/23/C++%E4%BB%A3%E7%A0%81%E6%A0%B7%E4%BE%8B/">
										C++代码样例
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/19/GPIB/">
										GPIB
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/Laravel/">
										Laravel
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/24/Linux%E5%9C%A8%E7%BA%BF/">
										Linux在线
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/29/MFC/">
										MFC
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/29/MFC%E5%A4%9A%E7%BA%BF%E7%A8%8B/">
										MFC多线程
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/MFC%E8%87%AA%E7%BB%98%E6%8C%89%E9%92%AE/">
										MFC自绘按钮
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/MFC%E8%87%AA%E7%BB%98%E6%A6%82%E8%BF%B0/">
										MFC自绘概述
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/SSDP%E5%BC%80%E5%8F%91%E8%AF%B4%E6%98%8E/">
										SSDP开发说明
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/STL_vector/">
										STL_vector
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/STL/">
										STL
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/WinHttp%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/">
										WinHttp使用详解
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/WinInet%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/">
										WinInet使用详解
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/Wininte%E6%A0%B7%E4%BE%8B%E8%A7%A3%E6%9E%90/">
										Wininte样例解析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/26/XML%E4%B9%8BIXMLHTTPReuest/">
										XML之IXMLHTTPReuest
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/XML%E6%93%8D%E4%BD%9C%E4%B9%8BCMarkUp/">
										XML操作之CMarkUp
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/XML%E8%A7%A3%E6%9E%90/">
										XML解析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/c++11/">
										c++11
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/06/c++%E5%B0%8F%E7%A8%8B%E5%BA%8F/">
										c++小程序
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/26/c-%E6%9C%AA%E5%BD%92%E7%B1%BB%E4%BB%A3%E7%A0%81/">
										c-未归类代码
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/hexo/">
										hexo
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file active">
									<a href="/2020/04/23/socket/">
										socket
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/24/thread-2/">
										thread-2
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/thread/">
										thread
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/vue%E7%AC%94%E8%AE%B0/">
										vue笔记
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/webpack%E4%BD%BF%E7%94%A8/">
										webpack使用
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/30/%E4%B8%B2%E5%8F%A3com%E7%BC%96%E7%A8%8B/">
										串口com编程
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/03/%E5%88%B7%E9%A2%98%E7%BA%AA%E5%BD%95/">
										刷题纪录
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/%E5%AD%97%E7%AC%A6%E7%B1%BB%E5%9E%8B/">
										字符类型
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/">
										小程序开发笔记
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/24/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E5%91%BD%E4%BB%A4/">
										常用工具命令
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99/">
										文件读写
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/04/23/%E7%BC%96%E7%A0%81%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2/">
										编码格式转换
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
		</div>
	</div>
</div>

	<!-- 引入正文 -->
	<div id="content">
		<h1 id="article-title">

	socket
</h1>
<div class="article-meta">
	
	<span>Been Stone</span>
	<span>2020-04-23 17:08:18</span>
    
		<div id="article-categories">
            
		</div>
    
</div>

<div id="article-content">
	<h1 id="网络编程"><a href="#网络编程" class="headerlink" title="网络编程"></a>网络编程</h1><p><a href="http://c.biancheng.net/view/2125.html" target="_blank" rel="noopener">面向连接和无连接的套接字的区别</a></p>
<h2 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h2><h3 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h3><pre><code class="cpp">SOCKET socket(int af, int type, int protocol);  //返回结果为SOCKET类型的句柄
SOCKET newsock = socket(AF_INET, SOCK_DGRAM, 0);            //UDP套接字</code></pre>
<h3 id="setsockopt"><a href="#setsockopt" class="headerlink" title="setsockopt"></a><a href="https://blog.csdn.net/c1520006273/article/details/50420408" target="_blank" rel="noopener">setsockopt</a></h3><pre><code class="cpp">int setsockopt(int sock, int level, int optname, const void* optval, socklen_t optlen);
int setsockopt(int s, int level, int optname, const char* optval, int optlen);  //VC++ 成功返回0，失败返回-1
bool bReuseaddr = true;
setsockopt(sock,SOL_SOCKET,SO_REUSEADDR,(const char*)&amp;bReuseaddr,sizeof(bool));      //允许复用本地地址和端口
int nTimeOut = 3000;
setsockopt(socket_desc, SOL_SOCKET, SO_RCVTIMEO, (char*)&amp;nTimeOut, sizeof(int));    //限制时间
bool bBroadcast = true;
setsockopt(s,SOL_SOCKET,SO_BROADCAST,(const char*)&amp;bBroadcast,sizeof(bool));</code></pre>
<h3 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h3><pre><code class="cpp">int bind(SOCKET sock, const struct sockaddr *addr, int addrlen);    //成功返回0，失败返回-1</code></pre>
<h3 id="listen"><a href="#listen" class="headerlink" title="listen"></a><a href="http://c.biancheng.net/view/2345.html" target="_blank" rel="noopener">listen</a></h3><pre><code class="cpp">int listen(SOCKET sock, int backlog);  
//成功返回0，失败返回-1 
//sock为要进入监听状态的套接字，backlog为请求队列的最大长度，最大值SOMAXCONN（由系统决定）
//应用程序可通过WSAGetLastError()获取相应错误代码</code></pre>
<h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><pre><code class="cpp">int connect(SOCKET sock, const struct sockaddr *serv_addr, int addrlen);        //成功返回0，失败-1，错误原因errno;</code></pre>
<h3 id="inet-pton"><a href="#inet-pton" class="headerlink" title="inet_pton"></a>inet_pton</h3><pre><code class="cpp">int inet_pton(int family, const char* pszAddrString, void* pAddrBuf);       //成功返回1，strptr无效返回0，出错返回-1
inet_pton(AF_INET, &quot;127.0.0.1&quot;, &amp;servAddr.sin_addr);    //INADDR_ANY</code></pre>
<h3 id="inet-ntop"><a href="#inet-ntop" class="headerlink" title="inet_ntop"></a>inet_ntop</h3><pre><code class="cpp">const char* inet_ntop(int family, const void* pAddr, char* pStringBuf, size_t StringBufSize);
char str[INET_ADDRSTRLEN];
char* ptr = inet_ntop(AF_INET, &amp;sockAddr.sin_addr,str,sizeof(str));     //inet_pton反函数</code></pre>
<h3 id="getsockopt"><a href="#getsockopt" class="headerlink" title="getsockopt"></a>getsockopt</h3><pre><code class="cpp">int getsockopt(int sock, int level, int optname, void* optval, socklen_t optlen);
unsigned optval;
int optLen = sizeof(int);
getsockopt(sock,SOL_SOCKET,SO_SNDBUF,(char*)&amp;optval, &amp;optLen);      //SO_SNDBUF 发送缓冲区大小</code></pre>
<h3 id="send"><a href="#send" class="headerlink" title="send"></a>send</h3><pre><code class="cpp">int send(SOCKET sock, const char* buf, size_t size, int flags);     //返回发送的字节数</code></pre>
<h3 id="sendto"><a href="#sendto" class="headerlink" title="sendto"></a>sendto</h3><pre><code class="cpp">int sendto(SOCKET sock, const char* buf, int nbytes, int flags, const struct sockadr* to, int addrlen)</code></pre>
<h3 id="recv"><a href="#recv" class="headerlink" title="recv"></a>recv</h3><pre><code class="cpp">int recv(SOCKET sock, char* buf, size_t size, int flags);   //返回接收到的字节数，一般flags为0或者NULL</code></pre>
<h3 id="recvfrom"><a href="#recvfrom" class="headerlink" title="recvfrom"></a>recvfrom</h3><pre><code class="cpp">int recvfrome(SOCKET sock, char* buf, int nbytes, int flags, const struct sockaddr* from, int* addrlen)</code></pre>
<h3 id="WSAGetLastError"><a href="#WSAGetLastError" class="headerlink" title="WSAGetLastError"></a>WSAGetLastError</h3><p>代码含义详见<a href="https://docs.microsoft.com/en-us/previous-versions/aa924071%28v%3dmsdn.10%29" target="_blank" rel="noopener">MSDN</a></p>
<pre><code class="cpp">int WSAGetLastError(void);      //WinSock2.h</code></pre>
<h2 id="常用函数解析"><a href="#常用函数解析" class="headerlink" title="常用函数解析"></a>常用函数解析</h2><h3 id="Inet-addr-vs-Inet-ntoa"><a href="#Inet-addr-vs-Inet-ntoa" class="headerlink" title="Inet_addr vs Inet_ntoa"></a>Inet_addr vs Inet_ntoa</h3><pre><code class="cpp">AfxSocketInit();

getsockname()
getpeername()
//将字符串转换为数字&quot;192.168.10.250&quot; → 0xfa0aa8c0
ULONG Inet_addr(const char* cp)
{
    ULONG lHost = 0;
    char* pHost = (char*)&amp;lHost;
    char* p = (char*)cp;
    while(p)
    {
        *pHost++ = atoi(p);
        p = strchr((char*)p,&#39;.&#39;);
        if(p)
            ++p;
    }
    return lHost
}

//反向操作
char* Inet_ntoa(struct in_addr in)
{
    static char s[100];
    sprintf(s,&quot;%d,%d,%d,%d&quot;, 
        in.S_un.S_un_b.s_b1,
        in.S_un.S_un_b.s_b2,
        in.S_un.S_un_b.s_b3,
        in.S_un.S_un_b.s_b4
    );
    return s;
}
</code></pre>
<h1 id="TCP连接"><a href="#TCP连接" class="headerlink" title="TCP连接"></a>TCP连接</h1><h2 id="server"><a href="#server" class="headerlink" title="server:"></a>server:</h2><ol>
<li>socket()         创建套接字；</li>
<li>bind()           绑定端口；</li>
<li>listen()         侦听侦听；</li>
<li>accept()         接纳客户端连接; </li>
<li>recv()/send()    收发消息；</li>
<li>closesocket()    关闭连接；</li>
</ol>
<h3 id="示例1："><a href="#示例1：" class="headerlink" title="示例1："></a>示例1：</h3><pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;winsock2.h&gt;
#include &lt;WS2tcpip.h&gt;
#pragma comment (lib, &quot;ws2_32.lib&quot;)  //加载 ws2_32.dll

int main() {
    //初始化套接字库 DLL
    WSADATA wsaData;
    //WSAStartup(0x0202, &amp;wsaData)
    if(WSAStartup(MAKEWORD(2, 2), &amp;wsaData) != 0)
        printf(&quot;WSAStartup() error!\n&quot;);

    //创建套接字
    SOCKET servSock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);

    //绑定本地地址和端口
    sockaddr_in sockAddr;
    memset(&amp;sockAddr, 0, sizeof(sockAddr));  //每个字节都用0填充
    sockAddr.sin_family = AF_INET;  //使用IPv4地址
    //sockAddr.sin_addr.s_addr = inet_addr(&quot;127.0.0.1&quot;);
    inet_pton(AF_INET,&quot;127.0.0.1&quot;,&amp;sockAddr.sin_addr);  //具体的IP地址
    sockAddr.sin_port = htons(1234);  //端口
    bind(servSock, (SOCKADDR*)&amp;sockAddr, sizeof(SOCKADDR));

    //把套接字设置为监听状态
    listen(servSock, 20);

    //接收客户端请求
    SOCKADDR clntAddr;
    int nSize = sizeof(SOCKADDR);
    SOCKET clntSock = accept(servSock, (SOCKADDR*)&amp;clntAddr, &amp;nSize);

    //向客户端发送数据
    const char* str = &quot;Hello World!&quot;;
    send(clntSock, str, strlen(str) + sizeof(char), NULL);

    //关闭套接字
    closesocket(clntSock);
    closesocket(servSock);

    //终止 DLL 的使用
    WSACleanup();

    return 0;
}</code></pre>
<h3 id="示例2："><a href="#示例2：" class="headerlink" title="示例2："></a>示例2：</h3><pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;WinSock2.h&gt;
#include &lt;WS2tcpip.h&gt;
#pragma comment(lib, &quot;ws2_32.lib&quot;)
#define BUF_SIZE 100

int main()
{
    //初始化DLL
    WSADATA wsaData;
    if (WSAStartup(0x0202, &amp;wsaData) != 0)  //2,2代表socket版本
        printf(&quot;WSAStartup() error!\n&quot;);
    //创建套接字,绑定本地端口
    SOCKET servSock = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);

    sockaddr_in servAddr = { AF_INET,htons(1234) };
    //memset(&amp;servAddr, 0, sizeof(servAddr)); //每个字节都用0填充
    //servAddr.sin_family = AF_INET;
    ////sockAddr.sin_addr.s_addr = inet_addr(&quot;127.0.0.1&quot;);
    //inet_pton(AF_INET, INADDR_ANY, &amp;servAddr.sin_addr); //具体的IP地址
    //servAddr.sin_port = htons(1234);
    bind(servSock, (SOCKADDR *)&amp;servAddr, sizeof(SOCKADDR));

    listen(servSock, 20);

    char bufRecv[BUF_SIZE];
    char bufSend[BUF_SIZE];
    SOCKADDR clientAddr;
    int nSize = sizeof(SOCKADDR);
    //接受客户端连接请求
    SOCKET clientSock = accept(servSock, (SOCKADDR *)&amp;clientAddr, &amp;nSize);

    char strAddr[INET_ADDRSTRLEN];
    inet_ntop(AF_INET, &amp;clientAddr.sa_data, strAddr, sizeof(strAddr));
    printf(&quot;Client: %s is connecting……\n&quot;, strAddr);
    while (true)
    {
        //接收客户端发来的数据
        memset(bufRecv, 0, BUF_SIZE);
        int len = recv(clientSock, bufRecv, BUF_SIZE, 0);
        /*
        unsigned optval;
        int optLen = sizeof(int);
        getsockopt(servSock, SOL_SOCKET, SO_SNDBUF, (char*)&amp;optval, &amp;optLen);
        */
        if (len &gt; 0)
        {
            printf(&quot;NUC7: %s, length: %d\n&quot;, bufRecv, len);
            printf(&quot;NUC6: &quot;);
            memset(bufSend, 0, BUF_SIZE);
            gets_s(bufSend, BUF_SIZE);
            send(clientSock, bufSend, strlen(bufSend), 0);
        }
        else
        {
            printf(&quot;对方已退出\n&quot;);
            break;
        }

    }

    //关闭套接字
    closesocket(servSock);
    closesocket(clientSock);
    //终止使用DLL
    WSACleanup();

    system(&quot;pause&quot;);
    return 0;
}</code></pre>
<h3 id="示例3：多线程"><a href="#示例3：多线程" class="headerlink" title="示例3：多线程"></a>示例3：多线程</h3><pre><code class="cpp">#define _WINSOCK_DEPRECATED_NO_WARNINGS
#include &lt;iostream&gt;
#include &lt;WinSock2.h&gt;
#include &lt;WS2tcpip.h&gt;
#pragma comment(lib, &quot;ws2_32.lib&quot;)
#include &lt;process.h&gt;
#define BUF_SIZE 100

using namespace std;

void theProc(void* p)
{
    const char* str = &quot;hello client!&quot;;
    SOCKET* pSock = (SOCKET*)p;
    SOCKET socka = *pSock;
    cout &lt;&lt; &quot;socka的地址是：&quot; &lt;&lt; &amp;socka &lt;&lt; &quot;  sock = &quot; &lt;&lt; socka &lt;&lt; endl;
    int i = send(socka, str, strlen(str), 0);
    char s[2048];
    SOCKADDR_IN sa = { AF_INET};
    int nLen = sizeof(sa);

    while (true)
    {
        getpeername(socka, (SOCKADDR*)&amp;sa, &amp;nLen);
        i = recv(socka, s, sizeof(s), 0);
        if (i &lt;= 0)
        {
            if (GetLastError() == 10054)
                cout &lt;&lt; inet_ntoa(sa.sin_addr)&lt;&lt;&quot;:&quot;&lt;&lt;htons(sa.sin_port)&lt;&lt; &quot; 退出了&quot; &lt;&lt; endl;
            break;
        }
        s[i] = 0;
        cout &lt;&lt; s &lt;&lt; endl;
    }
}

int main()
{
    //初始化DLL
    WSADATA wd;
    if (WSAStartup(0x0202, &amp;wd) != 0)  //2,2代表socket版本
        printf(&quot;WSAStartup() error!\n&quot;);
    //创建套接字,绑定本地端口
    SOCKET servSock = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
    if (INVALID_SOCKET == servSock)
    {
        cout &lt;&lt; GetLastError() &lt;&lt; endl;
        return -1;
    }

    sockaddr_in sa = { AF_INET,htons(1234) };
    if (bind(servSock, (SOCKADDR *)&amp;sa, sizeof(SOCKADDR)) &lt; 0)
    {
        cout &lt;&lt; GetLastError() &lt;&lt; endl;
        return -1;
    }

    listen(servSock, 20);
    SOCKADDR_IN sb = { AF_INET };
    int nLen = sizeof(sa);
    while (true)
    {
        SOCKET socka = accept(servSock,(SOCKADDR*)&amp;sb, &amp;nLen);
        cout &lt;&lt; inet_ntoa(sb.sin_addr) &lt;&lt; &quot;:&quot; &lt;&lt; htons(sb.sin_port) &lt;&lt; &quot; 登陆了&quot; &lt;&lt; endl;
        _beginthread(theProc, 0, &amp;socka);
    }
    return 0;
}</code></pre>
<h2 id="client"><a href="#client" class="headerlink" title="client:"></a>client:</h2><ol>
<li>socket()         创建套接字</li>
<li>connect()        发起连接请求</li>
<li>send()/recv()    收发数据</li>
<li>closesocket()    关闭连接</li>
</ol>
<h3 id="示例1：-1"><a href="#示例1：-1" class="headerlink" title="示例1："></a>示例1：</h3><pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;WinSock2.h&gt;
#include &lt;WS2tcpip.h&gt;
#pragma comment(lib, &quot;ws2_32.lib&quot;)  //加载 ws2_32.dll

int main() {
    //初始化DLL
    WSADATA wsaData;
    if(WSAStartup(MAKEWORD(2, 2), &amp;wsaData) != 0)
        printf(&quot;WSAStartup() error!\n&quot;);

    //创建套接字
    SOCKET sock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);

    //向服务器发起请求
    sockaddr_in sockAddr;
    memset(&amp;sockAddr, 0, sizeof(sockAddr));  //每个字节都用0填充
    sockAddr.sin_family = AF_INET;
    //sockAddr.sin_addr.s_addr = inet_addr(&quot;127.0.0.1&quot;);
    inet_pton(AF_INET, &quot;127.0.0.1&quot;, &amp;sockAddr.sin_addr);  //具体的IP地址
    sockAddr.sin_port = htons(1234);
    connect(sock, (SOCKADDR*)&amp;sockAddr, sizeof(SOCKADDR));

    //接收服务器传回的数据
    char szBuffer[MAXBYTE] = { 0 };
    recv(sock, szBuffer, MAXBYTE, NULL);

    //输出接收到的数据
    printf(&quot;Message form server: %s\n&quot;, szBuffer);

    //关闭套接字
    closesocket(sock);

    //终止使用 DLL
    WSACleanup();

    system(&quot;pause&quot;);
    return 0;
}</code></pre>
<h3 id="示例2：-1"><a href="#示例2：-1" class="headerlink" title="示例2："></a>示例2：</h3><pre><code class="cpp">#define _WINSOCK_DEPRECATED_NO_WARNINGS
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;WS2tcpip.h&gt;
#pragma comment(lib, &quot;ws2_32.lib&quot;)
#define BUF_SIZE 2048


int main()
{
    WSAData wsaData;
    WSAStartup(0x0202, &amp;wsaData);
    //向服务器发起请求
    SOCKET clientSock = socket(AF_INET, SOCK_STREAM, 0);

    SOCKADDR_IN sa = { AF_INET,htons(1234) };
    /*memset(&amp;clientAddr, 0, sizeof(clientAddr));
    clientAddr.sin_family = AF_INET;
    inet_pton(AF_INET, &quot;127.0.0.1&quot;, &amp;clientAddr.sin_addr);
    clientAddr.sin_port = htons(1234);*/
    sa.sin_addr.S_un.S_addr = inet_addr(&quot;127.0.0.1&quot;);
    connect(clientSock, (SOCKADDR*)&amp;sa, sizeof(SOCKADDR));

    char bufSend[BUF_SIZE] = { 0 };
    char bufRecv[BUF_SIZE] = { 0 };
    while (true)
    {
        //获取用户输入
        printf(&quot;NUC7: &quot;);
        memset(bufSend, 0, BUF_SIZE);
        gets_s(bufSend);
        send(clientSock, bufSend, strlen(bufSend), 0);
        //接收服务器传回的数据
        memset(bufRecv, 0, BUF_SIZE);
        int len = recv(clientSock, bufRecv, BUF_SIZE, NULL);
        if (len &gt; 0)
            printf(&quot;NUC6: %s, length: %d\n&quot;, bufRecv, len);
        else
        {
            printf(&quot;对方已退出，是否退出？(y/n):&quot;);
            char yn = getchar();
            if (yn == &#39;y&#39;)
                break;
        }
    }
    closesocket(clientSock);
    WSACleanup();

    system(&quot;pause&quot;);
    return 0;
}</code></pre>
<h1 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h1><h2 id="server-1"><a href="#server-1" class="headerlink" title="server:"></a>server:</h2><ol>
<li>socket()             创建套接字</li>
<li>bind()               绑定端口</li>
<li>recvfrom()/sendto()  收发消息</li>
<li>closesocket()        关闭连接</li>
</ol>
<h3 id="示例1：-2"><a href="#示例1：-2" class="headerlink" title="示例1："></a>示例1：</h3><pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;winsock2.h&gt;
#pragma comment (lib, &quot;ws2_32.lib&quot;)  //加载 ws2_32.dll
#define BUF_SIZE 100

int main(){
    WSADATA wsaData;
    WSAStartup( MAKEWORD(2, 2), &amp;wsaData);

    //创建套接字
    SOCKET sock = socket(AF_INET, SOCK_DGRAM, 0);

    //绑定套接字
    sockaddr_in servAddr;
    memset(&amp;servAddr, 0, sizeof(servAddr));  //每个字节都用0填充
    servAddr.sin_family = PF_INET;  //使用IPv4地址
    servAddr.sin_addr.s_addr = htonl(INADDR_ANY); //自动获取IP地址
    servAddr.sin_port = htons(1234);  //端口
    bind(sock, (SOCKADDR*)&amp;servAddr, sizeof(SOCKADDR));

    //接受客户端请求
    SOCKADDR clntAddr;  //客户端地址信息
    int nSize = sizeof(SOCKADDR);
    char buffer[BUF_SIZE];  //缓冲区
    while(1){
        int strLen = recvfrom(sock, buffer, BUF_SIZE, 0, &amp;clntAddr, &amp;nSize);
        sendto(sock, buffer, strLen, 0, &amp;clntAddr, nSize);
    }
    closesocket(sock);
    WSACleanup();
    return 0;
}</code></pre>
<h2 id="client-1"><a href="#client-1" class="headerlink" title="client:"></a>client:</h2><ol>
<li>socket()             创建套接字</li>
<li>sendto()/recvfrom()  收发数据</li>
<li>close()              关闭连接</li>
</ol>
<h3 id="示例1：-3"><a href="#示例1：-3" class="headerlink" title="示例1："></a>示例1：</h3><pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;WinSock2.h&gt;
#pragma comment(lib, &quot;ws2_32.lib&quot;)  //加载 ws2_32.dll
#define BUF_SIZE 100

int main(){
    //初始化DLL
    WSADATA wsaData;
    WSAStartup(MAKEWORD(2, 2), &amp;wsaData);

    //创建套接字
    SOCKET sock = socket(PF_INET, SOCK_DGRAM, 0);

    //服务器地址信息
    sockaddr_in servAddr;
    memset(&amp;servAddr, 0, sizeof(servAddr));  //每个字节都用0填充
    servAddr.sin_family = PF_INET;
    servAddr.sin_addr.s_addr = inet_addr(&quot;127.0.0.1&quot;);
    servAddr.sin_port = htons(1234);

    //不断获取用户输入并发送给服务器，然后接受服务器数据
    sockaddr fromAddr;
    int addrLen = sizeof(fromAddr);
    while(1){
        char buffer[BUF_SIZE] = {0};
        printf(&quot;Input a string: &quot;);
        gets(buffer);
        sendto(sock, buffer, strlen(buffer), 0, (struct sockaddr*)&amp;servAddr, sizeof(servAddr));
        int strLen = recvfrom(sock, buffer, BUF_SIZE, 0, &amp;fromAddr, &amp;addrLen);
        buffer[strLen] = 0;
        printf(&quot;Message form server: %s\n&quot;, buffer);
    }
    closesocket(sock);
    WSACleanup();
    return 0;
}</code></pre>
<h3 id="示例2：-2"><a href="#示例2：-2" class="headerlink" title="示例2："></a>示例2：</h3><pre><code class="cpp">//获取服务描述地址
int client(int max_num)
{
    FILE* fpw;
    const int opt = 1;
    int i = 0,
        recvLen = 0,
        timeout = 2000;
    SOCKADDR_IN servAddr;
    SOCKADDR fromAddr;

    WSADATA wsaData;
    if (0 != WSAStartup(MAKEWORD(2, 2), &amp;wsaData))
    {
        fprintf(stderr, &quot;WSAStartup() error!.\n&quot;);
        return -1;
    }

    SOCKET sock = socket(AF_INET, SOCK_DGRAM, 0);
    if (INVALID_SOCKET == sock)
    {
        printf(&quot;socket() error\n&quot;);
        return -1;
    }
    //设置广播模式
    if (setsockopt(sock, SOL_SOCKET, SO_BROADCAST, (char*)&amp;opt, sizeof(opt)) == -1)
    {
        printf(&quot;set socket error\n&quot;);
        return -1;
    }
    //设置超时时间
    if (setsockopt(sock, SOL_SOCKET, SO_RCVTIMEO, (char*)&amp;timeout, sizeof(timeout)) == -1)
    {
        printf(&quot;set socket error\n&quot;);
        return -1;
    }

    memset(&amp;servAddr, 0, sizeof(SOCKADDR_IN));
    servAddr.sin_family = AF_INET;
    inet_pton(AF_INET, &quot;239.255.255.250&quot;, &amp;servAddr.sin_addr);
    servAddr.sin_port = htons(1900);

    int addrLen = sizeof(fromAddr);
    char bufRecv[1024] = { 0 };
    char bufSend[] = &quot;M-SEARCH * HTTP/1.1\r\n\
HOST: 239.255.255.250:1900\r\n\
MAN: \&quot;ssdp:discover\&quot;\r\n\
ST: urn:schemas-upnp-org:device:MediaRenderer:1\r\n\
MX: 5\r\n\
\r\n&quot;;

    int sendLen = sendto(sock, bufSend, strlen(bufSend), 0, (SOCKADDR*)&amp;servAddr, sizeof(servAddr));
    printf(&quot;sendLen = %d\n&quot;, sendLen);

    fopen_s(&amp;fpw, &quot;./data.txt&quot;, &quot;w+&quot;);
    if(NULL == fpw)
    {
        fprintf(stderr, &quot;Failed to create data.txt.\n&quot;);
        return -1;
    }

    while (i++ &lt; max_num)
    {
        memset(bufRecv, 0, sizeof(bufRecv));
        recvLen = recvfrom(sock, bufRecv, sizeof(bufRecv), 0, &amp;fromAddr, &amp;addrLen);
        if (recvLen &gt; 0)
        {
            fwrite(bufRecv, recvLen, 1, fpw);
            printf(&quot;-------------------------recvLen = %d-------------\n&quot;, recvLen);
            printf(&quot;%s\n&quot;, bufRecv);
        }
        else
        {
            break;
        }
    }

    fclose(fpw);
    fpw = NULL;
    closesocket(sock);
    WSACleanup();
    return 0;
}</code></pre>

</div>


    <div class="post-guide">
        <div class="item left">
            
              <a href="/2020/04/23/Wininte%E6%A0%B7%E4%BE%8B%E8%A7%A3%E6%9E%90/">
                  <i class="fa fa-angle-left" aria-hidden="true"></i>
                  Wininte样例解析
              </a>
            
        </div>
        <div class="item right">
            
              <a href="/2020/04/23/XML%E8%A7%A3%E6%9E%90/">
                XML解析
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
            
        </div>
    </div>



	<div id="vcomments"></div>


<script>
	
		// 评论
		new Valine({
			av: AV,
			el: '#vcomments',
			notify: false,
			verify: false,
			path: window.location.pathname,
			appId: '',
			appKey: '',
			placeholder: '请输入评论',
			avatar: 'retro',
			recordIP: false
		})
	
	
</script>
	</div>
	<div id="footer">
	<p>
	©2019-<span id="footerYear"></span> 
	<a href="/">Been Stone</a> 
	
	
		|
		<span id="busuanzi_container_site_pv">
			pv
			<span id="busuanzi_value_site_pv"></span>
		</span>
		|
		<span id="busuanzi_container_site_uv"> 
			uv
			<span id="busuanzi_value_site_uv"></span>
		</span>
	
	<br>
	Theme <a href="//github.com/wujun234/hexo-theme-tree" target="_blank">Tree</a>
	by <a href="//github.com/wujun234" target="_blank">WuJun</a>
	Powered by <a href="//hexo.io" target="_blank">Hexo</a>
	</p>
</div>
<script type="text/javascript"> 
	document.getElementById('footerYear').innerHTML = new Date().getFullYear() + '';
</script>
	<button id="totop-toggle" class="toggle"><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
</body>
</html>